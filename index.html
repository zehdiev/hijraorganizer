<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Хиджра Календар Органайзър</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Допълнителни стилове, ако е необходимо */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;

        // Помощна функция за преобразуване на хиджри дата в григорианска (опростено приближение)
        // Това е опростено преобразуване и може да не е напълно точно за всички дати
        // поради сложността на лунния календар и различните методи на изчисление.
        // За приложение от производствен клас би се препоръчала надеждна библиотека за хиджри календар.
        const hijriToGregorian = (hijriYear, hijriMonth, hijriDay) => {
            // Известна референтна точка: 1 Мухаррем 1446 г. по Хиджра е приблизително 7 юли 2024 г. от н.е.
            const REFERENCE_HIJRI_YEAR = 1446;
            const REFERENCE_HIJRI_MONTH = 1; // Мухаррем
            const REFERENCE_HIJRI_DAY = 1;
            const REFERENCE_GREGORIAN_DATE = new Date(2024, 6, 7); // 7 юли 2024 г. (месецът е базиран на 0-индекс)

            // Средна продължителност на лунен месец в дни
            const AVG_LUNAR_MONTH_DAYS = 29.53;

            // Изчисляване на дните от референтната хиджри дата
            let daysDiff = 0;

            // Приблизителни дни за разлика в годините
            daysDiff += (hijriYear - REFERENCE_HIJRI_YEAR) * (12 * AVG_LUNAR_MONTH_DAYS);

            // Приблизителни дни за разлика в месеците
            // Забележка: Това е опростено. Действителните хиджри месеци редуват 29 и 30 дни.
            // За по-точно изчисление би трябвало да се проследява продължителността на всеки месец.
            for (let m = REFERENCE_HIJRI_MONTH; m < hijriMonth; m++) {
                daysDiff += AVG_LUNAR_MONTH_DAYS;
            }

            // Дни в текущия месец
            daysDiff += (hijriDay - REFERENCE_HIJRI_DAY);

            const gregorianDate = new Date(REFERENCE_GREGORIAN_DATE);
            gregorianDate.setDate(REFERENCE_GREGORIAN_DATE.getDate() + daysDiff);

            return gregorianDate;
        };

        // Имена на хиджри месеците на български
        const hijriMonths = [
            "Мухаррем", "Сафер", "Рабиюлеввел", "Рабиюлахир", "Джемазиюлеввел",
            "Джемазиюлахир", "Реджеб", "Шабан", "Рамазан", "Шеввал",
            "Зилкаде", "Зилхидже"
        ];

        // Функция за получаване на броя дни в хиджри месец (опростено приближение)
        // В действителност, хиджри месеците редуват 29 и 30 дни въз основа на наблюдението на луната.
        // Тази функция използва фиксиран модел за демонстрация.
        const getDaysInHijriMonth = (hijriYear, hijriMonth) => {
            // Опростен модел: нечетни месеци 30 дни, четни месеци 29 дни, Зул-Хиджа може да е 29 или 30
            if (hijriMonth % 2 !== 0) { // Нечетни месеци (Мухаррем, Рабиюлеввел и т.н.)
                return 30;
            } else if (hijriMonth === 12) { // Зилхидже
                // В реален календар това зависи от годината (високосна година за Хиджра)
                // За простота, ще го направим 29 дни, или 30 за високосни години (което не е изчислено тук)
                return 29; // Или 30 във високосна година, не е имплементирано тук
            } else { // Четни месеци
                return 29;
            }
        };

        const App = () => {
            const { useState } = React;
            const today = new Date();
            const currentGregorianYear = today.getFullYear();

            // Приблизителна текуща хиджри година за първоначален дисплей
            const initialHijriYear = currentGregorianYear - 622; // Много грубо приближение

            const [selectedHijriYear, setSelectedHijriYear] = useState(initialHijriYear);
            const [selectedHijriMonth, setSelectedHijriMonth] = useState(1); // 1-индекс (Мухаррем)
            const [notes, setNotes] = useState({}); // Съхранява бележки: { 'ГГГГ-ММ-ДД_Х': 'текст на бележка' }
            const [viewMode, setViewMode] = useState('month'); // 'month' или 'year'

            // Обработка на промяна в текста на бележката
            const handleNoteChange = useCallback((dateKey, text) => {
                setNotes(prevNotes => ({
                    ...prevNotes,
                    [dateKey]: text
                }));
            }, []);

            // Компонент за рендиране на един месец (използва се както за месечен, така и за годишен изглед)
            const renderMonthGrid = (hijriYear, hijriMonth, isYearView = false) => {
                const daysInMonth = getDaysInHijriMonth(hijriYear, hijriMonth);
                const calendarDays = [];

                const firstDayGregorian = hijriToGregorian(hijriYear, hijriMonth, 1);
                const gregorianDayOfWeek = firstDayGregorian.getDay(); // 0 за неделя, 1 за понеделник и т.н.
                const firstDayOfWeekAdjusted = (gregorianDayOfWeek + 6) % 7; // 0 за понеделник, 6 за неделя

                // Добавяне на празни клетки за дните преди 1-ви число на месеца
                for (let i = 0; i < firstDayOfWeekAdjusted; i++) {
                    calendarDays.push(<div key={`empty-${hijriMonth}-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const gregorianDate = hijriToGregorian(hijriYear, hijriMonth, day);
                    const gregorianDateString = gregorianDate.toLocaleDateString('bg-BG', {
                        day: 'numeric',
                        month: 'numeric',
                        year: 'numeric'
                    });
                    const dateKey = `${hijriYear}-${hijriMonth}-${day}`;

                    calendarDays.push(
                        <div key={dateKey} className="p-2 border border-gray-300 rounded-lg shadow-sm flex flex-col bg-white hover:shadow-md transition-shadow duration-200">
                            <div className="font-semibold text-base text-indigo-700"> {/* Намален размер на шрифта за деня */}
                                {day}
                            </div>
                            <div className="text-xs text-gray-600 mb-1"> {/* Намален mb */}
                                {gregorianDateString}
                            </div>
                            <textarea
                                className="w-full h-16 p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 resize-y text-xs" // Намалена височина и padding, размер на шрифта
                                value={notes[dateKey] || ''}
                                onChange={(e) => handleNoteChange(dateKey, e.target.value)}
                            ></textarea>
                        </div>
                    );
                }

                return (
                    <div className="mb-8"> {/* Отстояние между месеците в годишен изглед */}
                        {!isYearView && ( // Показва името на месеца и годината само в месечен изглед
                            <div className="text-2xl font-bold text-indigo-800 text-center mb-4">
                                {hijriMonths[hijriMonth - 1].toUpperCase()} {hijriYear} г.
                            </div>
                        )}
                        {isYearView && ( // Показва името на месеца и годината за всеки месец в годишен изглед
                            <h3 className="text-xl font-semibold text-indigo-700 text-center mb-2">
                                {hijriMonths[hijriMonth - 1]} {hijriYear} г.
                            </h3>
                        )}
                        <div className="grid grid-cols-7 gap-2 text-center font-bold text-gray-700 text-sm mb-2"> {/* Намален размер на шрифта за заглавията на дните */}
                            <div>Пн</div>
                            <div>Вт</div>
                            <div>Ср</div>
                            <div>Чт</div>
                            <div>Пт</div>
                            <div>Сб</div>
                            <div>Нд</div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays}
                        </div>
                    </div>
                );
            };

            // Преминаване към предишен месец
            const handlePrevMonth = () => {
                setSelectedHijriMonth(prevMonth => {
                    if (prevMonth === 1) {
                        setSelectedHijriYear(prevYear => prevYear - 1);
                        return 12;
                    }
                    return prevMonth - 1;
                });
            };

            // Преминаване към следващ месец
            const handleNextMonth = () => {
                setSelectedHijriMonth(prevMonth => {
                    if (prevMonth === 12) {
                        setSelectedHijriYear(prevYear => prevYear + 1);
                        return 1;
                    }
                    return prevMonth + 1;
                });
            };

            // Функция за сваляне на скрийншот
            const handleDownloadScreenshot = () => {
                const calendarElement = document.getElementById('calendar-container'); // ID на елемента, който ще се снима
                if (calendarElement) {
                    html2canvas(calendarElement, {
                        useCORS: true, // Важно за зареждане на външни ресурси, ако има такива
                        scale: 2 // Увеличава резолюцията на скрийншота
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `hijri-calendar-${viewMode}-screenshot.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }).catch(err => {
                        console.error("Грешка при генериране на скрийншот:", err);
                        // Можете да добавите съобщение за грешка на потребителя тук
                    });
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 p-6 font-sans antialiased">
                    <div id="calendar-container" className="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-8">
                        <h1 className="text-3xl font-extrabold text-center text-indigo-800 mb-6">
                            Хиджра Календар Органайзър
                        </h1>

                        {/* Навигация за месец/година и превключване на изгледа */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-8 p-4 bg-indigo-50 rounded-lg shadow-inner">
                            <div className="flex space-x-2 mb-4 sm:mb-0">
                                <button
                                    onClick={handlePrevMonth}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                >
                                    Предишен
                                </button>
                                <button
                                    onClick={handleNextMonth}
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                >
                                    Следващ
                                </button>
                            </div>

                            <div className="flex items-center space-x-4 mb-4 sm:mb-0">
                                <select
                                    className="p-3 border border-indigo-300 rounded-lg bg-white text-indigo-800 text-lg font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    value={selectedHijriMonth}
                                    onChange={(e) => setSelectedHijriMonth(parseInt(e.target.value))}
                                    disabled={viewMode === 'year'} // Деактивира се в годишен изглед
                                >
                                    {hijriMonths.map((month, index) => (
                                        <option key={index} value={index + 1}>
                                            {month}
                                        </option>
                                    ))}
                                </select>
                                <input
                                    type="number"
                                    className="p-3 border border-indigo-300 rounded-lg bg-white text-indigo-800 text-lg font-medium w-32 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    value={selectedHijriYear}
                                    onChange={(e) => setSelectedHijriYear(parseInt(e.target.value))}
                                    min="1300"
                                    max="1500"
                                />
                            </div>

                            <button
                                onClick={() => setViewMode(viewMode === 'month' ? 'year' : 'month')}
                                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                            >
                                {viewMode === 'month' ? 'Покажи цялата година' : 'Покажи месец'}
                            </button>
                        </div>

                        {/* Календарна мрежа - условно рендиране */}
                        {viewMode === 'month' ? (
                            renderMonthGrid(selectedHijriYear, selectedHijriMonth)
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {hijriMonths.map((_, index) => (
                                    <div key={`year-month-${index + 1}`} className="bg-gray-50 p-4 rounded-lg shadow-md">
                                        {renderMonthGrid(selectedHijriYear, index + 1, true)}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {/* Бутон за сваляне на скрийншот */}
                    <div className="flex justify-center mt-6">
                        <button
                            onClick={handleDownloadScreenshot}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 text-lg"
                        >
                            Свали скрийншот на календара
                        </button>
                    </div>
                </div>
            );
        };

        // Рендиране на React приложението в DOM
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
