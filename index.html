<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Хиджра Календар Органайзър</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Допълнителни стилове, ако е необходимо */
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Скрит по подразбиране */
            position: fixed; /* Стои над всичко */
            z-index: 1000; /* Висок z-index, за да е отгоре */
            left: 0;
            top: 0;
            width: 100%; /* Цяла ширина */
            height: 100%; /* Цяла височина */
            overflow: auto; /* Позволява скрол, ако е необходимо */
            background-color: rgba(0,0,0,0.4); /* Полупрозрачен фон */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Клас за скриване на бутона по време на скрийншот */
        .hide-on-screenshot {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // Имена на хиджри месеците на български
        const hijriMonths = [
            "Мухаррем", "Сафер", "Рабиюлеввел", "Рабиюлахир", "Джемазиюлеввел",
            "Джемазиюлахир", "Реджеб", "Шабан", "Рамазан", "Шеввал",
            "Зилкаде", "Зилхидже"
        ];

        // Функция за получаване на броя дни в хиджри месец (опростено приближение)
        // Тази функция дава ДЕФОЛТНИЯ брой дни, без ръчни корекции.
        const getDaysInHijriMonthDefault = (hijriMonth) => {
            if (hijriMonth % 2 !== 0) {
                return 30;
            } else if (hijriMonth === 12) {
                return 29;
            } else {
                return 29;
            }
        };

        // Нова помощна функция за изчисляване на Григорианската начална дата за даден Хиджри месец
        // Използва САМО дефолтните дължини на месеците, за да гарантира, че началните дати на месеците не се изместват.
        // Тази функция вече не се използва директно за изчисляване на GRIgorian start date,
        // а по-скоро за изчисляване на кумулативния offset, когато няма ръчно зададена дата.
        const getGregorianStartDateForHijriMonth = (targetHijriYear, targetHijriMonth, manualMonthDays, manualGregorianStartDates) => {
            const REFERENCE_HIJRI_YEAR = 1446;
            const REFERENCE_HIJRI_MONTH = 12; // Зилхидже
            const REFERENCE_HIJRI_DAY = 6;
            const REFERENCE_GREGORIAN_DATE = new Date(2025, 5, 2); // 2 юни 2025 г. (месецът е базиран на 0-индекс)

            const monthKey = `${targetHijriYear}-${targetHijriMonth}`;
            if (manualGregorianStartDates[monthKey]) {
                // Ако има ръчно зададена григорианска начална дата, използваме нея.
                // Важно: Съхраняваме датата като ISO string, затова я парсваме обратно
                return new Date(manualGregorianStartDates[monthKey]);
            }

            let daysOffset = 0;
            let currentHijriYear = REFERENCE_HIJRI_YEAR;
            let currentHijriMonth = REFERENCE_HIJRI_MONTH;

            // Helper to get actual days in a month, considering manual overrides
            // This is crucial for cumulative calculation
            const getActualDaysInMonth = (year, month) => {
                const key = `${year}-${month}`;
                return manualMonthDays[key] !== undefined ? manualMonthDays[key] : getDaysInHijriMonthDefault(month);
            };

            // Calculate days from REFERENCE_HIJRI_YEAR-REFERENCE_HIJRI_MONTH to targetHijriYear-targetHijriMonth
            // Adjust for years
            while (currentHijriYear < targetHijriYear) {
                for (let m = currentHijriMonth; m <= 12; m++) {
                    daysOffset += getActualDaysInMonth(currentHijriYear, m);
                }
                currentHijriYear++;
                currentHijriMonth = 1; // Reset to Muharram for the new year
            }
            while (currentHijriYear > targetHijriYear) {
                currentHijriYear--;
                for (let m = 12; m >= currentHijriMonth; m--) {
                    daysOffset -= getActualDaysInMonth(currentHijriYear, m);
                }
                currentHijriMonth = 12;
            }

            // Adjust for months within the same year
            if (currentHijriMonth < targetHijriMonth) {
                for (let m = currentHijriMonth; m < targetHijriMonth; m++) {
                    daysOffset += getActualDaysInMonth(currentHijriYear, m);
                }
            } else if (currentHijriMonth > targetHijriMonth) {
                for (let m = currentHijriMonth - 1; m >= targetHijriMonth; m--) {
                    daysOffset -= getActualDaysInMonth(currentHijriYear, m);
                }
            }

            // Adjust for the reference day itself (we want the start of the target month)
            daysOffset -= (REFERENCE_HIJRI_DAY - 1);

            const gregorianStartDate = new Date(REFERENCE_GREGORIAN_DATE);
            gregorianStartDate.setDate(REFERENCE_GREGORIAN_DATE.getDate() + daysOffset);

            return gregorianStartDate;
        };


        // Функция за преобразуване на хиджри дата в григорианска (с корекция "в края")
        const hijriToGregorian = (hijriYear, hijriMonth, hijriDay, manualMonthDays, manualGregorianStartDates) => {
            // Вземаме дефолтната григорианска начална дата за този хиджри месец
            // Тази функция вече включва логиката за ръчно зададени начални дати и кумулативни корекции
            const gregorianStartDateOfThisHijriMonth = getGregorianStartDateForHijriMonth(hijriYear, hijriMonth, manualMonthDays, manualGregorianStartDates);

            // Вземаме действителния (ръчно зададен или дефолтен) брой дни за *текущия* месец
            const monthKey = `${hijriYear}-${hijriMonth}`;
            const actualDaysInCurrentHijriMonth = manualMonthDays[monthKey] !== undefined
                ? manualMonthDays[monthKey]
                : getDaysInHijriMonthDefault(hijriMonth);

            // Уверяваме се, че hijriDay не надвишава действителния брой дни в месеца
            const adjustedHijriDay = Math.min(hijriDay, actualDaysInCurrentHijriMonth);

            // Изчисляваме григорианската дата, като добавяме дните към дефолтната начална дата на месеца
            const finalGregorianDate = new Date(gregorianStartDateOfThisHijriMonth);
            finalGregorianDate.setDate(gregorianStartDateOfThisHijriMonth.getDate() + (adjustedHijriDay - 1));

            return finalGregorianDate;
        };

        // Функция за получаване на символа за фазата на луната въз основа на григорианска дата (астрономически метод с 4 основни фази)
        const getMoonPhaseSymbol = (gregorianDate) => {
            // Референтна дата на новолуние: 6 януари 2000 г., 12:00 UTC
            const referenceNewMoon = new Date(Date.UTC(2000, 0, 6, 12, 0, 0));
            const millisecondsPerDay = 1000 * 60 * 60 * 24;
            const lunarCycle = 29.530588; // Синодичен период на Луната

            const daysSinceReference = (gregorianDate.getTime() - referenceNewMoon.getTime()) / millisecondsPerDay;
            let phaseIndex = daysSinceReference % lunarCycle;

            if (phaseIndex < 0) {
                phaseIndex += lunarCycle;
            }

            // Толеранс за показване на символа около точната фаза (много тесен диапазон)
            const displayTolerance = 0.75; 

            // Новолуние (около ден 0 или lunarCycle)
            if (phaseIndex < displayTolerance || phaseIndex >= lunarCycle - displayTolerance) return '🌑︎';
            // Първа четвърт (около ден lunarCycle / 4)
            if (phaseIndex >= (lunarCycle / 4) - displayTolerance && phaseIndex < (lunarCycle / 4) + displayTolerance) return '🌓︎';
            // Пълнолуние (около ден lunarCycle / 2)
            if (phaseIndex >= (lunarCycle / 2) - displayTolerance && phaseIndex < (lunarCycle / 2) + displayTolerance) return '🌕︎';
            // Последна четвърт (около ден lunarCycle * 3 / 4)
            if (phaseIndex >= (lunarCycle * 3 / 4) - displayTolerance && phaseIndex < (lunarCycle * 3 / 4) + displayTolerance) return '🌗︎';

            return ''; // Връща празен низ за дните извън тези диапазони
        };

        // Дефиниция на основните ислямски свещени дни и нощи за 1446 г. по Хиджра
        // Информацията е базирана на общоприети дати и може да варира леко
        // в зависимост от конкретното наблюдение на луната и региона.
        const sacredDaysAndNights = [
            // Реджеб (7-ми месец)
            { month: 7, day: 1, name: "Регаиб Кандиль" }, // Първият четвъртък вечер на Реджеб
            { month: 7, day: 27, name: "Мирадж Кандиль" }, // 27-ми Реджеб
            // Шабан (8-ми месец)
            { month: 8, day: 15, name: "Берат Кандиль" }, // 15-ти Шабан
            // Рамазан (9-ти месец)
            { month: 9, day: 27, name: "Кадир Геджеси" }, // 27-ми Рамазан (нощта на Кадир)
            // Шеввал (10-ти месец)
            { month: 10, day: 1, name: "Рамазан Байрам (1-ви ден)" }, // 1-ви Шеввал
            { month: 10, day: 2, name: "Рамазан Байрам (2-ри ден)" }, // 2-ри Шеввал
            { month: 10, day: 3, name: "Рамазан Байрам (3-ти ден)" }, // 3-ти Шеввал
            // Зилхидже (12-ти месец)
            { month: 12, day: 9, name: "Денят Арафа" }, // 9-ти Зилхидже
            { month: 12, day: 10, name: "Курбан Байрам (1-ви ден)" }, // 10-ти Зилхидже
            { month: 12, day: 11, name: "Курбан Байрам (2-ри ден)" }, // 11-ти Зилхидже
            { month: 12, day: 12, name: "Курбан Байрам (3-ти ден)" }, // 12-ти Зилхидже
            { month: 12, day: 13, name: "Курбан Байрам (4-ти ден)" }  // 13-ти Зилхидже
        ];


        const App = () => {
            const today = new Date();
            const currentGregorianYear = today.getFullYear();

            // Задаваме начална хиджри година и месец въз основа на потребителската корекция
            const initialHijriYear = 1446;
            const initialHijriMonth = 12; // Зилхидже

            const [selectedHijriYear, setSelectedHijriYear] = useState(initialHijriYear);
            const [selectedHijriMonth, setSelectedHijriMonth] = useState(initialHijriMonth);
            
            // Зареждане на viewMode от localStorage при инициализация
            const [viewMode, setViewMode] = useState(() => {
                try {
                    const savedViewMode = localStorage.getItem('viewMode');
                    return savedViewMode || 'year'; // Default to 'year' if not found, now explicitly 'year'
                } catch (error) {
                    console.error("Failed to load viewMode from localStorage:", error);
                    return 'year';
                }
            });

            const [notes, setNotes] = useState({}); // Съхранява бележки: { 'ГГГГ-ММ-ДД_Х': 'текст на бележка' }

            // Състояние за управление на модала за лунни фази
            const [showPhaseModal, setShowPhaseModal] = useState(false);
            const [modalDateKey, setModalDateKey] = useState(''); // Ключ на датата, за която отваряме модала

            // Състояние за съхранение на ръчно зададени фази
            const [manualMoonPhases, setManualMoonPhases] = useState({}); // {'YYYY-MM-DD': '🌑︎'}

            // Състояние за ръчно зададени дни в месеца
            const [manualMonthDays, setManualMonthDays] = useState({}); // {'YYYY-MM': 29/30}

            // Състояние за управление на модала за дни в месеца
            const [showMonthDaysModal, setShowMonthDaysModal] = useState(false);
            const [modalMonthKey, setModalMonthKey] = useState(''); // Ключ на месеца (пр. '1446-12')
            const [currentManualDays, setCurrentManualDays] = useState(0); // Брой дни в модала

            // Състояние за ръчно зададени григориански начални дати за Хиджри месеци
            const [manualGregorianStartDates, setManualGregorianStartDates] = useState({}); // {'HIJRI_YEAR-HIJRI_MONTH': 'YYYY-MM-DD'}
            const [isManualStartDateActive, setIsManualStartDateActive] = useState(false);
            const [currentManualStartDate, setCurrentManualStartDate] = useState(''); // За input type="date"

            // Функция за получаване на броя дни в хиджри месец, с приоритет за ръчните настройки
            const getDaysInHijriMonth = (hijriYear, hijriMonth) => {
                const monthKey = `${hijriYear}-${hijriMonth}`;
                if (manualMonthDays[monthKey] !== undefined) {
                    return manualMonthDays[monthKey];
                }
                return getDaysInHijriMonthDefault(hijriMonth);
            };

            // Обработка на промяна в текста на бележката
            const handleNoteChange = useCallback((dateKey, text) => {
                setNotes(prevNotes => ({
                    ...prevNotes,
                    [dateKey]: text
                }));
            }, []);

            // === Функции за Лунни Фази Модал ===
            const openPhaseModal = (dateKey) => {
                setModalDateKey(dateKey);
                setShowPhaseModal(true);
            };

            const closePhaseModal = () => {
                setShowPhaseModal(false);
                setModalDateKey('');
            };

            const handleManualPhaseSelection = (symbol) => {
                setManualMoonPhases(prevPhases => ({
                    ...prevPhases,
                    [modalDateKey]: symbol
                }));
                closePhaseModal();
            };

            const handleClearManualPhase = () => {
                setManualMoonPhases(prevPhases => {
                    const newPhases = { ...prevPhases };
                    newPhases[modalDateKey] = ''; // Задава празен низ, за да скрие както ръчни, така и автоматични фази
                    return newPhases;
                });
                closePhaseModal();
            };

            // === Функции за Дни в Месеца Модал ===
            const openMonthDaysModal = (monthKey, currentDays) => {
                setModalMonthKey(monthKey);
                setCurrentManualDays(currentDays);
                
                // Set initial state for manual Gregorian start date in modal
                const storedStartDate = manualGregorianStartDates[monthKey];
                if (storedStartDate) {
                    setIsManualStartDateActive(true);
                    setCurrentManualStartDate(storedStartDate);
                } else {
                    setIsManualStartDateActive(false);
                    // Calculate and set the default Gregorian start date for display purposes
                    const [hijriYear, hijriMonth] = monthKey.split('-').map(Number);
                    const defaultGregorianStart = getGregorianStartDateForHijriMonth(hijriYear, hijriMonth, manualMonthDays, manualGregorianStartDates);
                    setCurrentManualStartDate(defaultGregorianStart.toISOString().split('T')[0]); // Format as YYYY-MM-DD
                }

                setShowMonthDaysModal(true);
            };

            const closeMonthDaysModal = () => {
                setShowMonthDaysModal(false);
                setModalMonthKey('');
                setCurrentManualDays(0);
                setCurrentManualStartDate('');
                setIsManualStartDateActive(false);
            };

            const handleSaveManualMonthDays = () => {
                setManualMonthDays(prevDays => ({
                    ...prevDays,
                    [modalMonthKey]: currentManualDays
                }));

                if (isManualStartDateActive && currentManualStartDate) {
                    setManualGregorianStartDates(prevDates => ({
                        ...prevDates,
                        [modalMonthKey]: currentManualStartDate
                    }));
                } else {
                    setManualGregorianStartDates(prevDates => {
                        const newDates = { ...prevDates };
                        delete newDates[modalMonthKey];
                        return newDates;
                    });
                }
                closeMonthDaysModal();
            };

            const handleClearManualMonthDays = () => {
                setManualMonthDays(prevDays => {
                    const newDays = { ...prevDays };
                    delete newDays[modalMonthKey];
                    return newDays;
                });
                setManualGregorianStartDates(prevDates => {
                    const newDates = { ...prevDates };
                    delete newDates[modalMonthKey];
                    return newDates;
                });
                closeMonthDaysModal();
            };

            // === Зареждане на състояние от localStorage при първоначално зареждане ===
            useEffect(() => {
                try {
                    const savedNotes = localStorage.getItem('calendarNotes');
                    if (savedNotes) {
                        setNotes(JSON.parse(savedNotes));
                    }
                    const savedManualMoonPhases = localStorage.getItem('manualMoonPhases');
                    if (savedManualMoonPhases) {
                        setManualMoonPhases(JSON.parse(savedManualMoonPhases));
                    }
                    const savedManualMonthDays = localStorage.getItem('manualMonthDays');
                    if (savedManualMonthDays) {
                        setManualMonthDays(JSON.parse(savedManualMonthDays));
                    }
                    const savedManualGregorianStartDates = localStorage.getItem('manualGregorianStartDates');
                    if (savedManualGregorianStartDates) {
                        setManualGregorianStartDates(JSON.parse(savedManualGregorianStartDates));
                    }
                } catch (error) {
                    console.error("Failed to load state from localStorage:", error);
                }
            }, []);

            // === Запазване на състояние в localStorage при промяна ===
            useEffect(() => {
                try {
                    localStorage.setItem('calendarNotes', JSON.stringify(notes));
                } catch (error) {
                    console.error("Failed to save notes to localStorage:", error);
                }
            }, [notes]);

            useEffect(() => {
                try {
                    localStorage.setItem('manualMoonPhases', JSON.stringify(manualMoonPhases));
                } catch (error) {
                    console.error("Failed to save manualMoonPhases to localStorage:", error);
                }
            }, [manualMoonPhases]);

            useEffect(() => {
                try {
                    localStorage.setItem('manualMonthDays', JSON.stringify(manualMonthDays));
                } catch (error) {
                    console.error("Failed to save manualMonthDays to localStorage:", error);
                }
            }, [manualMonthDays]);

            useEffect(() => {
                try {
                    localStorage.setItem('manualGregorianStartDates', JSON.stringify(manualGregorianStartDates));
                } catch (error) {
                    console.error("Failed to save manualGregorianStartDates to localStorage:", error);
                }
            }, [manualGregorianStartDates]);

            // Запазване на viewMode в localStorage при промяна
            useEffect(() => {
                try {
                    localStorage.setItem('viewMode', viewMode);
                } catch (error) {
                    console.error("Failed to save viewMode to localStorage:", error);
                }
            }, [viewMode]);

            // === Функция за глобално запазване на всички настройки ===
            const handleSaveAllSettings = () => {
                try {
                    localStorage.setItem('calendarNotes', JSON.stringify(notes));
                    localStorage.setItem('manualMoonPhases', JSON.stringify(manualMoonPhases));
                    localStorage.setItem('manualMonthDays', JSON.stringify(manualMonthDays));
                    localStorage.setItem('manualGregorianStartDates', JSON.stringify(manualGregorianStartDates));
                    localStorage.setItem('viewMode', viewMode); // Запазване на viewMode
                    console.log("Всички настройки са запазени!");
                    // Можете да добавите визуална обратна връзка тук, например кратко съобщение "Запазено!"
                } catch (error) {
                    console.error("Грешка при запазване на всички настройки:", error);
                }
            };


            // Компонент за рендиране на един месец (използва се както за месечен, така и за годишен изглед)
            const renderMonthGrid = (hijriYear, hijriMonth, isYearView = false) => {
                const daysInMonth = getDaysInHijriMonth(hijriYear, hijriMonth);
                const calendarDays = [];

                // Get the Gregorian start date for this Hijri month using the updated hijriToGregorian
                const firstDayGregorian = hijriToGregorian(hijriYear, hijriMonth, 1, getDaysInHijriMonth, manualGregorianStartDates);
                const gregorianDayOfWeek = firstDayGregorian.getDay(); // 0 for Sunday, 1 for Monday, etc.
                // No adjustment needed if Sunday is 0.

                // Add empty cells for days before the 1st of the month
                for (let i = 0; i < gregorianDayOfWeek; i++) {
                    calendarDays.push(<div key={`empty-${hijriMonth}-${i}`} className="p-2"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    // Pass all necessary states to hijriToGregorian
                    const gregorianDate = hijriToGregorian(hijriYear, hijriMonth, day, getDaysInHijriMonth, manualGregorianStartDates);
                    // Format Gregorian date as DD.MM
                    const dayFormatted = gregorianDate.getDate().toString().padStart(2, '0');
                    const monthFormatted = (gregorianDate.getMonth() + 1).toString().padStart(2, '0');
                    const gregorianDateString = `${dayFormatted}.${monthFormatted}`;
                    
                    const dateKey = `${gregorianDate.getFullYear()}-${monthFormatted}-${dayFormatted}`; // Use Gregorian date for key

                    // Determine if the day is Friday (day 5 in JS Date, if Sunday is 0)
                    const isFriday = gregorianDate.getDay() === 5;
                    const cellBgClass = isFriday ? 'bg-green-100' : 'bg-white'; // Green background for Friday

                    // Get moon phase symbol
                    // If there's a manually set phase (even an empty string to clear), it takes precedence.
                    // Otherwise, use the automatically calculated phase.
                    const autoMoonPhaseSymbol = getMoonPhaseSymbol(gregorianDate);
                    const moonPhaseSymbolToDisplay = (manualMoonPhases[dateKey] !== undefined) ? manualMoonPhases[dateKey] : autoMoonPhaseSymbol;
                    
                    // The manual phase option button is always shown
                    const showManualOptionButton = true; 


                    calendarDays.push(
                        <div key={dateKey} className={`relative p-2 border border-gray-300 rounded-lg shadow-sm flex flex-col ${cellBgClass} hover:shadow-md transition-shadow duration-200`}>
                            {/* Button for manual phase setting */}
                            {showManualOptionButton && (
                                <button
                                    onClick={() => openPhaseModal(dateKey)}
                                    className="moon-phase-option-button absolute top-1 right-1 text-gray-500 hover:text-indigo-700 text-xs px-1 py-0.5 rounded-full bg-gray-100 hover:bg-indigo-200 transition-colors duration-200"
                                    title="Задай лунна фаза"
                                >
                                    ⚙︎
                                </button>
                            )}

                            {/* Хиджри ден и лунен символ (условно рендиране) */}
                            {isYearView ? (
                                <>
                                    <div className="font-semibold text-2xl text-indigo-700 text-center"> {/* Увеличен размер на хиджри деня */}
                                        <span>{day}</span>
                                    </div>
                                    <div className={`text-gray-600 mb-1 text-base text-center`}> {/* Увеличен размер на григорианската дата */}
                                        {gregorianDateString}
                                    </div>
                                    {moonPhaseSymbolToDisplay && <div className="text-xs text-center mt-1">{moonPhaseSymbolToDisplay}</div>} {/* Намален размер на символа на луната, под датите */}
                                </>
                            ) : (
                                <>
                                    <div className="flex justify-between items-center font-semibold text-2xl text-indigo-700"> {/* Увеличен размер на хиджри деня */}
                                        <span>{day}</span>
                                        {moonPhaseSymbolToDisplay && <span className="text-xs">{moonPhaseSymbolToDisplay}</span>} {/* Намален размер на символа на луната */}
                                    </div>
                                    <div className={`text-gray-600 mb-1 text-base`}> {/* Увеличен размер на григорианската дата */}
                                        {gregorianDateString}
                                    </div>
                                </>
                            )}
                            
                            {/* Полетата за писане се показват само ако не е годишен изглед */}
                            {!isYearView && (
                                <textarea
                                    className="w-full h-16 p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 resize-y text-xs"
                                    value={notes[dateKey] || ''}
                                    onChange={(e) => handleNoteChange(dateKey, e.target.value)}
                                ></textarea>
                            )}
                        </div>
                    );
                }

                // Филтриране на празниците за текущия месец
                const holidaysInMonth = sacredDaysAndNights.filter(
                    holiday => holiday.month === hijriMonth
                );

                return (
                    <div className="mb-8"> {/* Отстояние между месеците в годишен изглед */}
                        {!isYearView && ( // Показва името на месеца и годината само в месечен изглед
                            <div className="flex justify-center items-center mb-4">
                                <div className="text-2xl font-bold text-indigo-800 text-center mr-2">
                                    {hijriMonths[hijriMonth - 1].toUpperCase()} {hijriYear} г.
                                </div>
                                <button
                                    onClick={() => openMonthDaysModal(`${hijriYear}-${hijriMonth}`, getDaysInHijriMonth(hijriYear, hijriMonth))}
                                    className="moon-phase-option-button text-gray-500 hover:text-indigo-700 text-xs px-1 py-0.5 rounded-full bg-gray-100 hover:bg-indigo-200 transition-colors duration-200"
                                    title="Редактирай дни в месеца"
                                >
                                    ⚙︎
                                </button>
                            </div>
                        )}
                        {isYearView && ( // Показва името на месеца и годината за всеки месец в годишен изглед
                            <div className="flex justify-center items-center mb-2">
                                <h3 className="text-xl font-semibold text-indigo-700 text-center mr-2">
                                    {hijriMonths[hijriMonth - 1]} {hijriYear} г.
                                </h3>
                                <button
                                    onClick={() => openMonthDaysModal(`${hijriYear}-${hijriMonth}`, getDaysInHijriMonth(hijriYear, hijriMonth))}
                                    className="moon-phase-option-button text-gray-500 hover:text-indigo-700 text-xs px-1 py-0.5 rounded-full bg-gray-100 hover:bg-indigo-200 transition-colors duration-200"
                                    title="Редактирай дни в месеца"
                                >
                                    ⚙︎
                                </button>
                            </div>
                        )}
                        <div className="grid grid-cols-7 gap-2 text-center font-bold text-gray-700 text-sm mb-2"> {/* Намален размер на шрифта за заглавията на дните */}
                            <div>Нд</div>
                            <div>Пн</div>
                            <div>Вт</div>
                            <div>Ср</div>
                            <div>Чт</div>
                            <div>Пт</div>
                            <div>Сб</div>
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays}
                        </div>
                        {/* Показване на празниците под цялата мрежа на месеца (и в месечен, и в годишен изглед) */}
                        {holidaysInMonth.length > 0 && (
                            <div className="text-center text-sm text-gray-700 mt-4"> {/* Добавено mt-4 за отстояние */}
                                {holidaysInMonth.map((holiday, idx) => (
                                    <p key={idx} className="text-indigo-600 font-medium">
                                        {holiday.name} ({holiday.day} {hijriMonths[holiday.month - 1]})
                                    </p>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            // Преминаване към предишен месец
            const handlePrevMonth = () => {
                setSelectedHijriMonth(prevMonth => {
                    if (prevMonth === 1) {
                        setSelectedHijriYear(prevYear => prevYear - 1);
                        return 12;
                    }
                    return prevMonth - 1;
                });
            };

            // Преминаване към следващ месец
            const handleNextMonth = () => {
                setSelectedHijriMonth(prevMonth => {
                    if (prevMonth === 12) {
                        setSelectedHijriYear(prevYear => prevYear + 1);
                        return 1;
                    }
                    return prevMonth + 1;
                });
            };

            // Нова функция за преминаване към предишна година
            const handlePrevYear = () => {
                setSelectedHijriYear(prevYear => prevYear - 1);
            };

            // Нова функция за преминаване към следваща година
            const handleNextYear = () => {
                setSelectedHijriYear(prevYear => prevYear + 1);
            };

            // Функция за сваляне на скрийншот
            const handleDownloadScreenshot = () => {
                const calendarElement = document.getElementById('calendar-container'); // ID на елемента, който ще се снима
                if (calendarElement) {
                    // Временно скриване на всички бутони за опции на лунните фази
                    const optionButtons = document.querySelectorAll('.moon-phase-option-button');
                    optionButtons.forEach(button => button.classList.add('hide-on-screenshot'));

                    html2canvas(calendarElement, {
                        useCORS: true, // Важно за зареждане на външни ресурси, ако има такива
                        scale: 2 // Увеличава резолюцията на скрийншота
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `hijri-calendar-${viewMode}-screenshot.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }).catch(err => {
                        console.error("Грешка при генериране на скрийншот:", err);
                        // Можете да добавите съобщение за грешка на потребителя тук
                    }).finally(() => {
                        // Винаги показване на бутоните отново, независимо от резултата
                        optionButtons.forEach(button => button.classList.remove('hide-on-screenshot'));
                    });
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 p-6 font-sans antialiased">
                    <div id="calendar-container" className="max-w-full mx-auto bg-white rounded-xl shadow-2xl p-8">
                        <h1 className="text-3xl font-extrabold text-center text-indigo-800 mb-6">
                            Хиджра Календар Органайзър
                        </h1>

                        {/* Навигация за месец/година и превключване на изгледа */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-8 p-4 bg-indigo-50 rounded-lg shadow-inner">
                            {viewMode === 'month' ? (
                                <div className="flex space-x-2 mb-4 sm:mb-0">
                                    <button
                                        onClick={handlePrevMonth}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                    >
                                        Предишен Месец
                                    </button>
                                    <button
                                        onClick={handleNextMonth}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                    >
                                        Следващ Месец
                                    </button>
                                </div>
                            ) : (
                                <div className="flex space-x-2 mb-4 sm:mb-0">
                                    <button
                                        onClick={handlePrevYear}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                    >
                                        Предишна Година
                                    </button>
                                    <button
                                        onClick={handleNextYear}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                                    >
                                        Следваща Година
                                    </button>
                                </div>
                            )}

                            <div className="flex items-center space-x-4 mb-4 sm:mb-0">
                                <select
                                    className="p-3 border border-indigo-300 rounded-lg bg-white text-indigo-800 text-lg font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    value={selectedHijriMonth}
                                    onChange={(e) => setSelectedHijriMonth(parseInt(e.target.value))}
                                    disabled={viewMode === 'year'} // Деактивира се в годишен изглед
                                >
                                    {hijriMonths.map((month, index) => (
                                        <option key={index} value={index + 1}>
                                            {month}
                                        </option>
                                    ))}
                                </select>
                                <input
                                    type="number"
                                    className="p-3 border border-indigo-300 rounded-lg bg-white text-indigo-800 text-lg font-medium w-32 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    value={selectedHijriYear}
                                    onChange={(e) => setSelectedHijriYear(parseInt(e.target.value))}
                                    min="1300"
                                    max="1500"
                                />
                            </div>

                            <button
                                onClick={() => setViewMode(viewMode === 'month' ? 'year' : 'month')}
                                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105"
                            >
                                {viewMode === 'month' ? 'Покажи цялата година' : 'Покажи месец'}
                            </button>
                        </div>

                        {/* Календарна мрежа - условно рендиране */}
                        {viewMode === 'month' ? (
                            renderMonthGrid(selectedHijriYear, selectedHijriMonth)
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-8">
                                {hijriMonths.map((_, index) => (
                                    <div key={`year-month-${index + 1}`} className="bg-gray-50 p-4 rounded-lg shadow-md">
                                        {renderMonthGrid(selectedHijriYear, index + 1, true)}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {/* Бутони за сваляне на скрийншот и запазване на настройки */}
                    <div className="flex justify-center mt-6">
                        <button
                            onClick={handleDownloadScreenshot}
                            className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 text-lg mr-4"
                        >
                            Свали скрийншот на календара
                        </button>
                        <button
                            onClick={handleSaveAllSettings}
                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 text-lg"
                        >
                            Запази всички настройки
                        </button>
                    </div>

                    {/* Модал за избор на лунна фаза */}
                    {showPhaseModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <span className="close-button" onClick={closePhaseModal}>&times;</span>
                                <h2 className="text-xl font-bold mb-4">Избери лунна фаза за {modalDateKey}</h2>
                                <div className="flex justify-around mb-4">
                                    <button
                                        onClick={() => handleManualPhaseSelection('🌑︎')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-2xl"
                                    >
                                        🌑︎
                                    </button>
                                    <button
                                        onClick={() => handleManualPhaseSelection('🌓︎')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-2xl"
                                    >
                                        🌓︎
                                    </button>
                                    <button
                                        onClick={() => handleManualPhaseSelection('🌕︎')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-2xl"
                                    >
                                        🌕︎
                                    </button>
                                    <button
                                        onClick={() => handleManualPhaseSelection('🌗︎')}
                                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-2xl"
                                    >
                                        🌗︎
                                    </button>
                                </div>
                                <button
                                    onClick={handleClearManualPhase}
                                    className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full"
                                >
                                    Изчисти фазата
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Модал за регулиране на дни в месеца */}
                    {showMonthDaysModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <span className="close-button" onClick={closeMonthDaysModal}>&times;</span>
                                <h2 className="text-xl font-bold mb-4">Редактирай дни за {hijriMonths[parseInt(modalMonthKey.split('-')[1]) - 1]} {modalMonthKey.split('-')[0]} г.</h2>
                                <div className="mb-4">
                                    <label htmlFor="daysInMonth" className="block text-gray-700 text-sm font-bold mb-2">Брой дни:</label>
                                    <input
                                        type="number"
                                        id="daysInMonth"
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center"
                                        value={currentManualDays}
                                        onChange={(e) => setCurrentManualDays(parseInt(e.target.value) || 0)}
                                        min="29"
                                        max="30"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Хиджри месеците обикновено са 29 или 30 дни.</p>
                                </div>
                                <div className="mb-4">
                                    <label className="inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            className="form-checkbox"
                                            checked={isManualStartDateActive}
                                            onChange={(e) => setIsManualStartDateActive(e.target.checked)}
                                        />
                                        <span className="ml-2 text-gray-700 text-sm font-bold">Задай григорианска начална дата ръчно</span>
                                    </label>
                                    <input
                                        type="date"
                                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center mt-2"
                                        value={currentManualStartDate}
                                        onChange={(e) => setCurrentManualStartDate(e.target.value)}
                                        disabled={!isManualStartDateActive}
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        Ако е зададена ръчно, тази дата ще фиксира началото на месеца.
                                        Промените в броя дни на месеца ще се отразят само в края му, без да изместват следващите месеци.
                                    </p>
                                </div>
                                <div className="flex justify-around">
                                    <button
                                        onClick={handleSaveManualMonthDays}
                                        className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full"
                                    >
                                        Запази
                                    </button>
                                    <button
                                        onClick={handleClearManualMonthDays}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full"
                                    >
                                        Изчисти ръчна настройка
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the React application into the DOM
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
